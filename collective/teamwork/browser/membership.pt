<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      metal:use-macro="context/main_template/macros/master"
      i18n:domain="collective.teamwork">
<head>
  <metal:block fill-slot="javascript_head_slot">
    <script
      type="text/javascript"
      src="++resource++collective.teamwork/js/membership.js"
      tal:attributes="src string:${context/@@plone_portal_state/navigation_root_url}/++resource++collective.teamwork/js/membership.js?rev=20140618">
    </script>
  </metal:block>
  <metal:block fill-slot="style_slot">
    <link
      rel="stylesheet"
      href="++resource++collective.teamwork/css/membership.css"
      tal:attributes="href string:${context/@@plone_portal_state/navigation_root_url}/++resource++collective.teamwork/css/membership.css" />
  </metal:block>
</head>
<body>
<div metal:fill-slot="main"
     tal:define="is_project python:context.restrictedTraverse('@@workspace_helper').context_is_project();
                 type_title view/type_title;
                 mail_icon string:${context/@@plone_portal_state/navigation_root_url}/mail_icon.png;
                 delete_icon string:${context/@@plone_portal_state/navigation_root_url}/delete_icon.png;"
    tal:attributes="data-typetitle type_title;
                    data-isproject is_project">
 <h2>Manage workgroup roles for this <span tal:replace="type_title">workspace</span></h2> 

  <h3 class="workgroup-title"><em tal:content="context/Title">TITLE</em><strong tal:condition="is_project"> (Project)</strong></h3>
  <div class="actions">
    <div class="membership-action-buttons">
      <div class="addcontrol">
        <a href="#adduser"
          class="plone-btn plone-btn-large plone-btn-primary pat-plone-modal addbtn"
          data-pat-plone-modal="width:600"
          title="Add a user to this workspace's workgroup(s)"
          >
            (+) Add a user
        </a>
      </div>
    </div>
    <ul class="nobullet action-secondary">
      <li class="icon-mask">
        <span>
          View the
          <a href="./@@roster" target="_blank" class="view-roster">
            <span class="type_title" tal:content="type_title">workspace</span>
            roster
          </a>, as seen by non-manager members.
        </span>
      </li>
      <li class="icon-table">
        <span>
          Export
          <a href="@@csv_listing">CSV listing</a>
          of users and their assignments.
        </span>
      </li>
    </ul>
  </div>
  <div style="clear:both"></div>
  <div class="instructions">
    <div class="page_section">  <!-- Membership roles grid for existing members/viewers -->
      <div class="portalMessage info">
        <p style="font-weight:bold">
          There are <span tal:replace="python:len(view.roster)">#</span> workgroup members 
          for this <span class="type_title" tal:content="type_title">workspace</span>.
        </p>
        <p class="formHelp">
         Workgroup members have assigned at minimum the "<span class="type_title" tal:content="python:type_title.title()">Workspace</span> Viewers" group assignment.
        </p>
      </div>
      <p class="formHelp">To remove a user or send password email, click the lock icon (<span class="icon-lock"></span>)
        in the <span class="type_title" tal:content="python:type_title.title()">Workspace</span>
        Viewers column to unlock the user for password reset or removal from project and/or site.
        To get more information about a user, click on the info icon (<span class="icon-info"></span>)
        next to the user.</p>
    </div>
    <div class="role-management">
   <form>
    <table class="listing" tal:define="groups view/groups; cols python:len(groups);">
     <tr class="odd">
       <th rowspan="2">User name, email</th>
       <th colspan="4" style="color:black;" tal:attributes="colspan cols">
            <span class="type_title" tal:content="python:type_title.title()">Workspace</span> group assignments
       </th>
     </tr>
     <tr class="odd">
       <th tal:repeat="group groups">
        <tal:block define="heading group/title">
         <span tal:replace="python:heading.replace('Workspace', type_title.title())"></span>
        </tal:block>
       </th>
     </tr>
     <tr tal:repeat="user view/roster/values">
      <tal:block define="email python:user.getProperty('email');
                         username python:user.getUserName();
                         fullname python:user.getProperty('fullname');
                         groups python:view.groups(username);">
       <td class="userinfo">
         <input type="hidden" tal:attributes="name string:managegroups-${username}" value="managed" />
         <div>
           <span tal:replace="fullname">NAME</span>
           <a href=""
              class="userinfo pat-plone-modal"
              data-pat-plone-modal="width:600;"
              tal:attributes="href string:./@@user_info?principal=${username}">
                <span class="icon-info"></span>
           </a>
         </div>
         <div class="email">
           <a href="" tal:attributes="href string:mailto:${email}">&lt;<span tal:replace="email">EMAIL</span>&gt;</a>
         </div>
       </td>
       <td class="gridcell" tal:repeat="group groups">
         <tal:block condition="python:group['groupid'] == 'viewers'">
           <strong class="checkmark" style="font-size:200%;color:#999;">&#x2713;</strong>
           <a class="unlock">
            <span class="icon-lock muted"></span>
           </a>
           <div class="lockbox">
            <input type="checkbox"
                    class="locked"
                    name=""
                    checked="CHECKED"
                    tal:condition="python: group['checked']"
                    tal:attributes="name string:group-${group/groupid}/${username}"
                    />
            <a href=""
                tal:attributes="href string:./mail_password_form?userid=${username}"
                  class="password-reset icon-email pat-plone-modal"
                  data-pat-plone-modal="width:650"
                  >
                    Send password reset email
              </a>
              <tal:block condition="python:view.can_purge(username)">
                <a href=""
                  class="purge icon-remove pat-plone-modal"
                  title="Purge user from site permanently"
                  data-pat-plone-modal="width:650"
                  tal:attributes="href string:./@@user_purge?purgeuser=${username}"
                  >
                    (Permanently Remove)
                  </a>
             </tal:block>
           </div>
         </tal:block>
         <tal:block condition="python:group['groupid'] != 'viewers'">
           <input type="checkbox"
                  name=""
                  tal:condition="python: not group['checked']"
                  tal:attributes="name string:group-${group/groupid}/${username}"
                  />
           <input type="checkbox"
                  name=""
                  checked="CHECKED"
                  tal:condition="python: group['checked']"
                  tal:attributes="name string:group-${group/groupid}/${username}"
                  />
         </tal:block>
       </td>
      </tal:block>
     </tr>
    </table>
    <input name="grid_update" type="submit" value="Update workspace roles" />
   </form>
  </div>
 </div>

 <pre style="display:none">
   <div id="adduser" class="adduser">
     <h3>Add a user to this <span tal:replace="type_title">workspace</span></h3>
     <p class="formHelp">You may search existing users or register new users here.</p>
     <div class="find-existing">
       <h4>Find and add</h4>
       <form method="POST">
         <input
           class="pat-select2"
           data-pat-select2="placeholder:Input all or part (minimum 2 charaters) of a name or email address to find;
                             vocabularyUrl:@@search_members;
                             allowClear:true;
                             allowNewItems:false;
                             width:30em;"
           name="input_addusers"
           />

         <input type="submit" name="select_existing_users" value="Add selected users to project membership" />
         <p class="formHelp">Note: site users who already have <span class="type_title" tal:content="type_title">workspace</span> membership will be omitted from any result.</p>
       </form>
     </div>
     <div class="register-new">
       <h4>Register new user</h4>
     </div>
   </div>
 </pre>

 <div class="page_section register_user" style="display:none">
  <h3>Register a new site member, add to <span class="type_title" tal:content="type_title">workspace</span>:</h3>
  <p class="formHelp">
    Create a new user not yet registered for this site, and add that user as a
    <span class="type_title" tal:content="type_title">workspace</span>
    member.
  </p>
  <form method="POST" style="display:block; margin-left:2em;" >
  <div>
   <label style="display:block;">E-mail address</label>
   <input name="newuser_email" />
  </div>
  <div style="margin-top:0.5em;">
   <label style="display:block;">Full name</label>
   <input name="newuser_fullname" />
  </div>
  <div style="margin-top:0.5em;">
   <input name="newuser_sendmail" type="checkbox" checked="CHECKED" />
   <label style="display:block;"><em>Send welcome (password setup) email to user.</em></label>
  </div>
  <br />
  <input name="register_new_user" type="submit" value="Register new user" />
  </form>
  <p class="formHelp">
      The member's e-mail address will be the ID used to login. By adding a new user,
      an initial random password and notification email to the user's email will be 
      generated. The link sent to the user in the notification email will present 
      the opportunity for the user to select their own password.
  </p>
 </div>

</div>
</body>
</html>
